<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CJCM Order Validation Healthcheck</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Segoe UI, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 10px 0; font-size: 20px; }
    .note { color: #555; margin: 6px 0; }
    .error { color: #d93025; }
    .success { color: #188038; font-weight: 600; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f4f4f4; text-align: left; }
    .actions { margin: 10px 0; display: flex; gap: 12px; align-items: center; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #999; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>CJCM Order Validation Healthcheck</h1>
  <div id="status" class="note">Loading data and sending email... <span class="spinner"></span></div>
  <div class="actions">
    <button id="btnRetry" type="button">Retry</button>
    <a id="previewLink" href="#" target="_blank" style="display:none;">Open email preview</a>
  </div>
  <div id="results"></div>

  <script>
    const ORACLE_ENDPOINT = 'http://127.0.0.1:8765/oracle/query';
    const MAIL_ENDPOINT = 'http://127.0.0.1:8765/mail/send';

    const SQL = `SELECT * FROM (
    SELECT 
        SOURCE_TABLE,
        WORKOBJECTSTATUS,
        SAMPLE_CARTS,
        TRUNC(PXCREATEDATETIME) as CREATED_DATE,
        COUNT(*) OVER (PARTITION BY SOURCE_TABLE, WORKOBJECTSTATUS) as "Total"
    FROM (
        SELECT 'LINE' as SOURCE_TABLE, WORKOBJECTSTATUS, PXCREATEDATETIME, CARTID FROM POJO_data.vzcm_data_lineentity
        UNION ALL
        SELECT 'SUBMIT' as SOURCE_TABLE, WORKOBJECTSTATUS, PXCREATEDATETIME, CARTID FROM POJO_data.vzcm_data_ordersubmitentity
        UNION ALL
        SELECT 'CONFIRM' as SOURCE_TABLE, WORKOBJECTSTATUS, PXCREATEDATETIME, CARTID FROM POJO_data.vzcm_data_orderconfirmationentity
    ) combined_data
    LEFT JOIN (
        SELECT SOURCE_TABLE as ST, WORKOBJECTSTATUS as WS, 
               LISTAGG(CARTID, ', ') WITHIN GROUP (ORDER BY CARTID) as SAMPLE_CARTS
        FROM (
            SELECT DISTINCT SOURCE_TABLE, WORKOBJECTSTATUS, CARTID
            FROM (
                SELECT 'LINE' as SOURCE_TABLE, WORKOBJECTSTATUS, CARTID,
                       ROW_NUMBER() OVER (PARTITION BY WORKOBJECTSTATUS ORDER BY CARTID) as rn 
                FROM POJO_data.vzcm_data_lineentity
                UNION ALL
                SELECT 'SUBMIT' as SOURCE_TABLE, WORKOBJECTSTATUS, CARTID,
                       ROW_NUMBER() OVER (PARTITION BY WORKOBJECTSTATUS ORDER BY CARTID) as rn 
                FROM POJO_data.vzcm_data_ordersubmitentity
                UNION ALL
                SELECT 'CONFIRM' as SOURCE_TABLE, WORKOBJECTSTATUS, CARTID,
                       ROW_NUMBER() OVER (PARTITION BY WORKOBJECTSTATUS ORDER BY CARTID) as rn 
                FROM POJO_data.vzcm_data_orderconfirmationentity
            ) WHERE rn <= 3
        )
        GROUP BY SOURCE_TABLE, WORKOBJECTSTATUS
    ) samples ON combined_data.SOURCE_TABLE = samples.ST AND combined_data.WORKOBJECTSTATUS = samples.WS
    WHERE PXCREATEDATETIME BETWEEN TO_TIMESTAMP('2026-01-10T00:00', 'YYYY-MM-DD"T"HH24:MI') 
                                 AND TO_TIMESTAMP('2026-01-12T23:59', 'YYYY-MM-DD"T"HH24:MI')
)
PIVOT (
    COUNT(CREATED_DATE) 
    FOR CREATED_DATE IN (
        TO_DATE('2026-01-10', 'YYYY-MM-DD') AS "10-Jan-26",
        TO_DATE('2026-01-11', 'YYYY-MM-DD') AS "11-Jan-26",
        TO_DATE('2026-01-12', 'YYYY-MM-DD') AS "12-Jan-26"
    )
)
ORDER BY SOURCE_TABLE, "Total" DESC`;

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function buildTable(columns, rows){
      const thead = '<thead><tr>' + (columns||[]).map(c => `<th>${escapeHtml(c)}</th>`).join('') + '</tr></thead>';
      const tbody = '<tbody>' + (rows||[]).map(r => '<tr>' + r.map(v => `<td>${escapeHtml(v===null||v===undefined?'':v)}</td>`).join('') + '</tr>').join('') + '</tbody>';
      return '<table>' + thead + tbody + '</table>';
    }

    async function runHealthcheck(){
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');
      const previewLink = document.getElementById('previewLink');
      statusEl.innerHTML = 'Loading data and sending email... <span class="spinner"></span>';
      previewLink.style.display = 'none';
      try {
        const resp = await fetch(ORACLE_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sql: SQL, params: {}, maxRows: 5000 }) });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Query failed');
        const tableHtml = buildTable(data.columns || [], data.rows || []);
        resultsEl.innerHTML = tableHtml;
        // Compose email HTML
        const subject = 'CJCM Order Validation Healthcheck (10-12 Jan 2026)';
        const bodyHtml = `
          <div style="font-family:Segoe UI,Arial,sans-serif;font-size:13px;">
            <h2 style="font-size:16px;margin:0 0 8px 0;">CJCM Order Validation Healthcheck</h2>
            <div style="margin:4px 0;">Date window: 2026-01-10 to 2026-01-12</div>
            ${tableHtml}
          </div>`;
        const mailResp = await fetch(MAIL_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to: 'marieswari.palanimarimuthu@verizon.com', subject, html: bodyHtml }) });
        let mailData = {};
        try { mailData = await mailResp.json(); } catch {}
        if (mailResp.ok && (mailData.ok || mailData.sent)){
          statusEl.innerHTML = '<span class="success">Email sent successfully.</span>';
        } else {
          const msg = mailData.error ? String(mailData.error) : `HTTP ${mailResp.status}`;
          statusEl.innerHTML = `<span class="error">Email send failed: ${escapeHtml(msg)}</span>`;
          if (mailData.previewPath){ previewLink.href = `http://127.0.0.1:8765${mailData.previewUrl || '/reporting.csv'}`; previewLink.textContent = 'Open email preview'; previewLink.style.display = 'inline-block'; }
        }
      } catch (e){
        statusEl.innerHTML = `<span class="error">${escapeHtml(e.message)}</span>`;
      }
    }

    document.getElementById('btnRetry').addEventListener('click', runHealthcheck);
    window.addEventListener('DOMContentLoaded', runHealthcheck);
  </script>
</body>
</html>
